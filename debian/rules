#!/usr/bin/make -f
# -*- makefile -*-

conf=--disable-nsdejavu --disable-desktopfiles

build: build-stamp debian/djvulibre-djview4.xpm
build-stamp:
	dh build --before auto_configure
	dh_auto_configure -- $(conf)
	dh build --after auto_configure
	touch build-stamp

debian/djvulibre-djview4.xpm: desktopfiles/djview.svg
	convert -geometry 32x32 -depth 8 -background none $< $@

clean:
	dh $@
ifneq "$(wildcard /usr/share/misc/config.sub)" ""
	cp -f /usr/share/misc/config.sub config/config.sub
endif
ifneq "$(wildcard /usr/share/misc/config.guess)" ""
	cp -f /usr/share/misc/config.guess config/config.guess
endif

plugsubdir=netscape/plugins-libc6
icon=djvulibre-djview4
iconbasedir=debian/tmp/usr/share/icons/hicolor

install: install-stamp
install-stamp: build
	dh install --before auto_configure
	dh_auto_configure -- $(conf)
	dh install --after dh_auto_configure --before dh_auto_install
	dh_auto_install -- plugindir=/usr/lib/$(plugsubdir) DESTDIR=$(CURDIR)/debian/tmp
	@echo "flush djview links, handled with debian alternatives system"
	rm debian/tmp/usr/bin/djview
	rm debian/tmp/usr/share/man/man1/djview.*
	@echo "flush nsdejavu, also in djvulibre"
	find debian/tmp -name nsdejavu\* -print -delete
	@echo "install djview4 icons"
	mkdir --parents $(iconbasedir)/scalable/apps
	mkdir --parents $(iconbasedir)/32x32/apps
	mkdir --parents $(iconbasedir)/64x64/apps
	cp desktopfiles/hi-djview4.svgz  $(iconbasedir)/scalable/apps/$(icon).svgz
	cp desktopfiles/hi32-djview4.png $(iconbasedir)/32x32/apps/$(icon).png
	cp desktopfiles/hi64-djview4.png $(iconbasedir)/64x64/apps/$(icon).png
	dh install --after dh_auto_install
	touch install-stamp

binary binary-arch binary-indep: install
	dh $@

.PHONY: build clean binary-indep binary-arch binary install
